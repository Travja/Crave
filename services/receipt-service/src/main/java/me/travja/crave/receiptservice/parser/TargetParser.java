/*
https://redsky.target.com/redsky_aggregations/v1/web/plp_search_v1?key=ff457966e64d5e877fdbad070f276d18ecec4a01&channel=WEB&keyword=212141185&page=%2Fs%2F212141185&pricing_store_id=2641&visitor_id=017C7143EA910201809F9312AD49BB2B

{
    "data": {
        "search": {
            "search_recommendations": {},
            "search_response": {
                "facet_list": [
                    {
                        "name": "d_categorytaxonomy",
                        "type": "url",
                        "display_name": "Category",
                        "expand": true,
                        "details": [
                            {
                                "display_name": "Toys",
                                "url": "keyword=323013841&sort_by=relevance&count=24&offset=0&category=5xtb0",
                                "value": "5xtb0"
                            }
                        ]
                    },
                    {
                        "name": "d_pricerange",
                        "type": "price",
                        "display_name": "Price",
                        "expand": true,
                        "details": [
                            {
                                "display_name": "$0 &nbsp;&ndash;&nbsp; $15",
                                "facet_id": "5zja2",
                                "url": "d_pricerange:0000 $0 - $15",
                                "value": "0000 $0 - $15"
                            }
                        ]
                    },
                    {
                        "name": "d_sellers_all",
                        "type": "checkbox",
                        "display_name": "Sold by",
                        "expand": true,
                        "details": [
                            {
                                "display_name": "Target",
                                "facet_id": "dq4mn",
                                "url": "d_sellers_all:0000 target",
                                "value": "0000 target"
                            }
                        ]
                    },
                    {
                        "name": "d_channel",
                        "type": "checkbox",
                        "display_name": "Shipping & Pickup",
                        "expand": false,
                        "details": [
                            {
                                "display_name": "shipping",
                                "facet_id": "5zktx",
                                "url": "d_channel:shipping",
                                "value": "shipping"
                            },
                            {
                                "display_name": "include out of stock",
                                "facet_id": "fwtfr",
                                "url": "d_channel:include out of stock",
                                "value": "include out of stock"
                            },
                            {
                                "display_name": "same day delivery",
                                "facet_id": "cl92v",
                                "url": "d_channel:same day delivery",
                                "value": "same day delivery"
                            }
                        ]
                    },
                    {
                        "name": "d_item_type_all",
                        "type": "checkbox",
                        "display_name": "Type",
                        "expand": false,
                        "details": [
                            {
                                "display_name": "Mini Figures",
                                "facet_id": "5v071",
                                "url": "d_item_type_all:mini figures",
                                "value": "mini figures"
                            }
                        ]
                    },
                    {
                        "name": "d_brand_all",
                        "type": "checkbox",
                        "display_name": "Brand",
                        "expand": false,
                        "details": [
                            {
                                "display_name": "Funko",
                                "facet_id": "4ynjc",
                                "url": "d_brand_all:funko",
                                "value": "funko"
                            },
                            {
                                "display_name": "Hasbro",
                                "facet_id": "5xvyq",
                                "url": "d_brand_all:hasbro",
                                "value": "hasbro"
                            }
                        ]
                    },
                    {
                        "name": "d_deals",
                        "type": "checkbox",
                        "display_name": "Deals",
                        "expand": false,
                        "details": [
                            {
                                "display_name": "All Deals",
                                "facet_id": "akkos",
                                "url": "d_deals:all deals",
                                "value": "all deals"
                            },
                            {
                                "display_name": "Buy and Save",
                                "facet_id": "55e6t",
                                "url": "d_deals:buy and save",
                                "value": "buy and save"
                            },
                            {
                                "display_name": "Sale",
                                "facet_id": "5tdv0",
                                "url": "d_deals:sale",
                                "value": "sale"
                            }
                        ]
                    },
                    {
                        "name": "d_rating",
                        "type": "rating",
                        "display_name": "Guest Rating",
                        "expand": false,
                        "details": [
                            {
                                "display_name": "1",
                                "facet_id": "5zkq2",
                                "url": "d_rating:0000 1",
                                "value": "0000 1"
                            },
                            {
                                "display_name": "2",
                                "facet_id": "5zkq3",
                                "url": "d_rating:0001 2",
                                "value": "0001 2"
                            },
                            {
                                "display_name": "3",
                                "facet_id": "5zkq4",
                                "url": "d_rating:0002 3",
                                "value": "0002 3"
                            },
                            {
                                "display_name": "4",
                                "facet_id": "5zkq5",
                                "url": "d_rating:0003 4",
                                "value": "0003 4"
                            }
                        ]
                    },
                    {
                        "name": "d_apo_fpo",
                        "type": "checkbox",
                        "display_name": "FPO/APO",
                        "expand": false,
                        "details": [
                            {
                                "display_name": "only eligible items",
                                "facet_id": "vu13f",
                                "url": "d_apo_fpo:only eligible items",
                                "value": "only eligible items"
                            }
                        ]
                    }
                ],
                "typed_metadata": {
                    "count": 24,
                    "current_page": 1,
                    "keyword": "323013841",
                    "offset": 0,
                    "sort_by": "relevance",
                    "total_pages": 1,
                    "total_results": 1
                },
                "sort_options": [
                    {
                        "name": "relevance",
                        "value": "relevance"
                    },
                    {
                        "name": "Featured",
                        "value": "Featured"
                    },
                    {
                        "name": "PriceLow",
                        "value": "price-low to high"
                    },
                    {
                        "name": "PriceHigh",
                        "value": "price-high to low"
                    },
                    {
                        "name": "RatingHigh",
                        "value": "average ratings"
                    },
                    {
                        "name": "bestselling",
                        "value": "best seller"
                    },
                    {
                        "name": "newest",
                        "value": "newest"
                    }
                ]
            },
            "products": [
                {
                    "__typename": "ProductSummary",
                    "tcin": "79661847",
                    "original_tcin": "79661847",
                    "item": {
                        "relationship_type": "Stand Alone",
                        "relationship_type_code": "SA",
                        "merchandise_classification": {
                            "class_id": 1,
                            "department_id": 323
                        },
                        "eligibility_rules": {
                            "add_on": {
                                "is_active": true
                            }
                        },
                        "enrichment": {
                            "buy_url": "https://www.target.com/p/funko-pop-retro-toys-hasbro-mr-potato-head-mixed-face-target-exclusive/-/A-79661847",
                            "images": {
                                "primary_image_url": "https://target.scene7.com/is/image/Target/GUEST_27f88d96-c33f-4b41-8649-3d52b811f773",
                                "alternate_image_urls": [
                                    "https://target.scene7.com/is/image/Target/GUEST_0dc62588-7b3e-4d87-bad0-f9814578784f"
                                ]
                            }
                        },
                        "choking_hazard": [
                            {
                                "code": "choking_hazard_small_parts"
                            }
                        ],
                        "dpci": "323-01-3841",
                        "mmbv_content": {
                            "street_date": "2020-11-13"
                        },
                        "cart_add_on_threshold": 35.0,
                        "product_description": {
                            "title": "Funko POP! Retro Toys: Hasbro - Mr. Potato Head (Mixed Face)(Target Exclusive)",
                            "bullet_descriptions": [
                                "<B>Dimensions (Overall):</B> 6.5 Inches (H) x 4.5 Inches (W) x 3.5 Inches (D)",
                                "<B>Weight:</B> .25 Pounds",
                                "<B>Suggested Age:</B> 3 Years and Up",
                                "<B>Number of Figures:</B> 1",
                                "<B>CPSC Choking Hazard Warnings:</B> Choking_hazard_small_parts",
                                "<B>Includes:</B> 1 Figure",
                                "<B>Material:</B> Vinyl",
                                "<B>Battery:</B> No Battery Used"
                            ],
                            "soft_bullets": {
                                "bullets": [
                                    "Target Exclusive",
                                    "3 3/4\" Figure",
                                    "Ages 3+",
                                    "Box Dimensions: 6.5 x 4.5 x 3.5\""
                                ]
                            }
                        },
                        "product_vendors": [
                            {
                                "vendor_name": "FUNKO LLC",
                                "id": "1228797"
                            }
                        ],
                        "fulfillment": {},
                        "primary_brand": {
                            "canonical_url": "/b/funko/-/N-4ynjc",
                            "name": "Funko",
                            "facet_id": "4ynjc"
                        },
                        "ribbons": [
                            "Only At Target"
                        ]
                    },
                    "promotions": [
                        {
                            "plp_message": "Spend $50 save $10 on Toys Purchase",
                            "promotion_id": "507489916",
                            "promotion_class": "Hurdle",
                            "ship_method": [
                                "ShipToStore",
                                "EXPRESS_1DAY",
                                "LTL_WHITE_GLOVE_ASSEMBLY",
                                "LTL_INSIDE_THE_DOOR",
                                "STANDARD",
                                "PREMIUM_2DAY",
                                "SCHEDULED_DELIVERY_PPO",
                                "LTL_ROOM_OF_CHOICE",
                                "WHENEVER",
                                "BuyInStore",
                                "LTL_TO_THE_DOOR",
                                "SEASONAL",
                                "PickupInStore",
                                "RUSH_DELIVERY",
                                "LTL_WHITE_GLOVE",
                                "SCHEDULED_DELIVERY"
                            ],
                            "subscription_type": "ALL",
                            "threshold_type": "minAmount",
                            "threshold_value": 49.0,
                            "reward_type": "DollarOff",
                            "reward_value": 10.0,
                            "external_promotion_alternate_id": "349027",
                            "circle_offer": true
                        },
                        {
                            "plp_message": "Spend $100 save $25 on Toys Purchase",
                            "promotion_id": "231876030",
                            "promotion_class": "Hurdle",
                            "ship_method": [
                                "LTL_WHITE_GLOVE_ASSEMBLY",
                                "RUSH_DELIVERY",
                                "SEASONAL",
                                "ShipToStore",
                                "WHENEVER",
                                "BuyInStore",
                                "STANDARD",
                                "LTL_ROOM_OF_CHOICE",
                                "PREMIUM_2DAY",
                                "SCHEDULED_DELIVERY_PPO",
                                "LTL_TO_THE_DOOR",
                                "PickupInStore",
                                "LTL_INSIDE_THE_DOOR",
                                "LTL_WHITE_GLOVE",
                                "SCHEDULED_DELIVERY",
                                "EXPRESS_1DAY"
                            ],
                            "subscription_type": "ALL",
                            "threshold_type": "minAmount",
                            "threshold_value": 99.0,
                            "reward_type": "DollarOff",
                            "reward_value": 25.0,
                            "external_promotion_alternate_id": "349028",
                            "circle_offer": true
                        }
                    ],
                    "price": {
                        "current_retail": 4.49,
                        "formatted_current_price": "$4.49",
                        "formatted_current_price_type": "sale",
                        "formatted_comparison_price": "$8.99",
                        "formatted_comparison_price_type": "reg",
                        "urgency": "Ends Tuesday"
                    },
                    "ratings_and_reviews": {
                        "statistics": {
                            "rating": {
                                "average": 4.87,
                                "count": 15
                            }
                        }
                    }
                }
            ]
        }
    }
}
*/
package me.travja.crave.receiptservice.parser;

import me.travja.crave.common.models.ProductInformation;
import me.travja.crave.receiptservice.models.TargetItem;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

@Service
public class TargetParser implements ReceiptProcessor {
    private static Pattern pattern         = Pattern.compile("(\\d+)[ ](\\b.*\\b)[ ]\\w{1,2}[ ]\\$(\\d+\\.\\d{2})");
    private static Pattern regPricePattern = Pattern.compile("Regular Price \\$(\\d+\\.\\d{2})",
            Pattern.CASE_INSENSITIVE);

    public final RestTemplate restTemplate;
    private final String targetVisitorId = "017C7143EA910201809F9312AD49BB2B";
    private final String targetStoreId   = "2641";
    private final String targetKey       = "ff457966e64d5e877fdbad070f276d18ecec4a01";
    public TargetParser(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @Override
    public List<ProductInformation> parseData(List<String> list) {
        List<ProductInformation> prodInfo = new ArrayList<>();

        for (int i = 0, listSize = list.size(); i < listSize; i++) {
            String line = list.get(i);

            if (!line.matches(pattern.pattern()))
                continue;

            String  nextLine       = null;
            boolean shouldContinue = true;
            if (list.size() > i + 1) {
                String next = list.get(i + 1);
                if (next.matches(regPricePattern.pattern()))
                    nextLine = next;
                else if (next.matches(pattern.pattern()))
                    shouldContinue = false;
            }

            if (shouldContinue && nextLine == null && list.size() > i + 2) {
                String next = list.get(i + 2);
                if (next.matches(regPricePattern.pattern()))
                    nextLine = next;
            }

            System.out.println(line);

            Matcher mat = pattern.matcher(line);
            if (mat.find()) {
                String name      = mat.group(2);
                String dpci      = mat.group(1);
                double salePrice = Double.parseDouble(mat.group(3));
                double price     = salePrice;
                if (nextLine != null) {
                    Matcher priceMat = regPricePattern.matcher(nextLine);
                    if (priceMat.find()) {
                        price = Double.parseDouble(priceMat.group(1));
                    }
                }
                TargetItem item = getTargetItem(dpci);

                if (item == null) {
                    System.out.println("Couldn't get item information for " + name + "(" + dpci + ")");
                    continue;
                }
                ProductInformation info = new ProductInformation(item.getName(), item.getUpc(), price);
                prodInfo.add(info);

                if (salePrice < price)
                    System.out.println(item.getName() + " is discounted for some reason from " + price + " to "
                            + salePrice);
            }
        }

        return prodInfo;
    }

    public TargetItem getTargetItem(String dpci) {
        String url = new StringBuilder("https://redsky.target.com/redsky_aggregations/v1/web/plp_search_v1"
                + "?key=" + targetKey + "&channel=WEB"
                + "&keyword=" + dpci + "&page=%2Fs%2F" + dpci
                + "&pricing_store_id=" + targetStoreId // Salt Lake
                + "&visitor_id=" + targetVisitorId)
                .toString();

        TargetResponse response = restTemplate.getForObject(url, TargetResponse.class);

        //Should return a single item...
        if (response.getData().getSearch().getProducts().size() >= 1) {
            TargetResponse.TargetData.Product prod = response.getData().getSearch().getProducts().get(0);
            return new TargetItem(prod);
        } else
            return null;
    }
}
